<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Cosmic Timeline v4 (Live Counters Fixed)</title>
<style>
/* (same styles as before) */
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  background: #000;
  color: #fff;
  font-family: 'Courier New', monospace;
  display: flex;
  justify-content: center;
  align-items: center;
  min-height: 100vh;
  overflow: auto;
}

#container {
  position: relative;
  margin: 20px;
}

#controls {
  position: absolute;
  top: -45px;
  left: 0;
  z-index: 10;
  background: rgba(0, 0, 0, 0.9);
  padding: 8px 12px;
  border: 1px solid #333;
  border-radius: 4px;
  display: flex;
  align-items: center;
  gap: 12px;
}

#controls input[type="date"] {
  font-size: 12px;
  padding: 4px;
  background: #111;
  color: #fff;
  border: 1px solid #555;
  border-radius: 3px;
}

#controls button {
  font-size: 12px;
  padding: 4px 10px;
  background: #222;
  color: #0ff;
  border: 1px solid #0ff;
  border-radius: 3px;
  cursor: pointer;
  font-family: 'Courier New', monospace;
}

#controls button:hover {
  background: #0ff;
  color: #000;
}

.mode-switch {
  display: flex;
  align-items: center;
  gap: 6px;
}

.mode-label {
  font-size: 10px;
  color: #888;
}

.switch {
  position: relative;
  display: inline-block;
  width: 40px;
  height: 18px;
}

.switch input {
  opacity: 0;
  width: 0;
  height: 0;
}

.slider {
  position: absolute;
  cursor: pointer;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: #555;
  transition: .3s;
  border-radius: 18px;
}

.slider:before {
  position: absolute;
  content: "";
  height: 12px;
  width: 12px;
  left: 3px;
  bottom: 3px;
  background-color: white;
  transition: .3s;
  border-radius: 50%;
}

input:checked + .slider {
  background-color: #f00;
}

input:checked + .slider:before {
  transform: translateX(22px);
}

.mode-text {
  font-size: 10px;
  color: #0f0;
  font-weight: bold;
  min-width: 65px;
}

canvas {
  border: 2px solid #333;
  display: block;
  background-size: cover;
  background-position: center;
}

#timeSync {
  position: absolute;
  bottom: -35px;
  right: 0;
  background: rgba(0, 0, 0, 0.9);
  padding: 6px 10px;
  border: 1px solid #333;
  border-radius: 3px;
  font-size: 10px;
  color: #888;
}

#info {
  position: absolute;
  bottom: -35px;
  left: 0;
  font-size: 10px;
  background: rgba(0, 0, 0, 0.9);
  padding: 6px 10px;
  border: 1px solid #333;
  border-radius: 3px;
}

.status-dot {
  display: inline-block;
  width: 6px;
  height: 6px;
  border-radius: 50%;
  margin-right: 4px;
}

.status-synced {
  background: #0f0;
  box-shadow: 0 0 3px #0f0;
  animation: pulse 2s infinite;
}

.status-syncing {
  background: #ff0;
  box-shadow: 0 0 3px #ff0;
}

.status-offline {
  background: #f00;
  box-shadow: 0 0 3px #f00;
}

@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.5; }
}
</style>
</head>
<body>

<div id="container">
  <div id="controls">
    <label>Birth Date: <input type="date" id="birthDate"></label>
    <button id="resetZoom">Reset View</button>
    
    <div class="mode-switch">
      <span class="mode-label">Mode:</span>
      <label class="switch">
        <input type="checkbox" id="modeToggle">
        <span class="slider"></span>
      </label>
      <span class="mode-text" id="modeText">Linear</span>
    </div>
  </div>

  <canvas id="cosmicCanvas" width="800" height="480"></canvas>

  <div id="timeSync">
    <span class="status-dot status-syncing" id="statusDot"></span>
    <span id="syncStatus">Syncing...</span>
  </div>

  <div id="info">
    Drag to pan • Scroll to zoom • Zoom: <span id="zoomLevel">1.00x</span>
  </div>
</div>

<!-- Background Music -->
<audio id="bgMusic" loop>
  <source src="space.mp3" type="audio/mpeg">
</audio>

<script>
// =============================
// Canvas Setup
// =============================
const canvas = document.getElementById("cosmicCanvas");
const ctx = canvas.getContext("2d");

const WIDTH = 800;
const HEIGHT = 480;

// Load background image
const bgImage = new Image();
bgImage.src = "space.jpg";
bgImage.onerror = () => {
  console.log("Background image not found, using black background");
};

// =============================
// Timeline Mode (Linear / Log)
// =============================
let isLinearMode = true;
const modeToggle = document.getElementById("modeToggle");
const modeText = document.getElementById("modeText");

modeToggle.addEventListener("change", () => {
  isLinearMode = !modeToggle.checked;
  modeText.textContent = isLinearMode ? "Linear" : "Logarithmic";
  modeText.style.color = isLinearMode ? "#0f0" : "#f00";
});
modeText.style.color = "#0f0";

// =============================
// Background Music
// =============================
const bgMusic = document.getElementById("bgMusic");
bgMusic.volume = 0.3;

function startMusic() {
  bgMusic.play().catch(err => {
    console.log("Autoplay blocked, waiting for user interaction");
    document.addEventListener('click', () => {
      bgMusic.play().catch(e => console.log("Music play failed:", e));
    }, { once: true });
  });
}

// =============================
// Time Synchronization
// =============================
let timeOffset = 0;
let isTimeSynced = false;
let universeStartTime = null;
let serverTimeBase = null;
let localTimeBase = null;

async function syncWithWorldTime() {
  try {
    const statusDot = document.getElementById('statusDot');
    const syncStatus = document.getElementById('syncStatus');
    
    statusDot.className = 'status-dot status-syncing';
    syncStatus.textContent = 'Syncing...';
    
    const response = await fetch('https://worldtimeapi.org/api/timezone/Etc/UTC');
    const data = await response.json();
    
    serverTimeBase = data.unixtime * 1000;
    localTimeBase = Date.now();
    timeOffset = serverTimeBase - localTimeBase;
    
    const UNIVERSE_AGE_MS = 13.787e9 * 365.25 * 24 * 60 * 60 * 1000;
    universeStartTime = serverTimeBase - UNIVERSE_AGE_MS;
    
    isTimeSynced = true;
    statusDot.className = 'status-dot status-synced';
    syncStatus.textContent = `Synced (UTC)`;
    
    startMusic();
    
    console.log('Time synced successfully');
    
  } catch (error) {
    console.error('Time sync failed:', error);
    const statusDot = document.getElementById('statusDot');
    const syncStatus = document.getElementById('syncStatus');
    statusDot.className = 'status-dot status-offline';
    syncStatus.textContent = 'Local time';
    
    localTimeBase = Date.now();
    serverTimeBase = localTimeBase;
    timeOffset = 0;
    
    const UNIVERSE_AGE_MS = 13.787e9 * 365.25 * 24 * 60 * 60 * 1000;
    universeStartTime = localTimeBase - UNIVERSE_AGE_MS;
    isTimeSynced = false;
    
    startMusic();
  }
}

function getCurrentTime() {
  return Date.now() + timeOffset;
}

syncWithWorldTime();
setInterval(syncWithWorldTime, 60 * 60 * 1000);

// =============================
// Pan & Zoom
// =============================
let offsetX = 0;
let offsetY = 0;
let zoom = 1.0;
let isDragging = false;
let dragStart = {x: 0, y: 0};
let dragOffsetStart = {x: 0, y: 0};

canvas.addEventListener("mousedown", e => {
  isDragging = true;
  dragStart = {x: e.offsetX, y: e.offsetY};
  dragOffsetStart = {x: offsetX, y: offsetY};
});

canvas.addEventListener("mouseup", () => isDragging = false);
canvas.addEventListener("mouseleave", () => isDragging = false);

canvas.addEventListener("mousemove", e => {
  if (isDragging) {
    offsetX = dragOffsetStart.x + (e.offsetX - dragStart.x) / zoom;
    offsetY = dragOffsetStart.y + (e.offsetY - dragStart.y) / zoom;
  }
});

canvas.addEventListener("wheel", e => {
  e.preventDefault();
  const scaleFactor = 1.1;
  const mouseX = e.offsetX;
  const mouseY = e.offsetY;
  const worldX = (mouseX / zoom - offsetX);
  const worldY = (mouseY / zoom - offsetY);
  zoom *= e.deltaY < 0 ? scaleFactor : 1 / scaleFactor;
  offsetX = mouseX / zoom - worldX;
  offsetY = mouseY / zoom - worldY;
});

document.getElementById('resetZoom').addEventListener('click', () => {
  zoom = 1.0;
  offsetX = 0;
  offsetY = 0;
});

// =============================
// Constants
// =============================
const UNIVERSE_AGE_YEARS = 13.787e9;
const SECONDS_PER_YEAR = 365.25 * 24 * 60 * 60;
const BIG_BANG_SECONDS_AGO = UNIVERSE_AGE_YEARS * SECONDS_PER_YEAR;
const DOT_RADIUS = 2.5;

// =============================
// User Birth Date
// =============================
let birthDate = null;

document.getElementById("birthDate").addEventListener("change", e => {
  birthDate = new Date(e.target.value);
});

// =============================
// Historical Events
// =============================
const EVENTS = [
  { name: "AI Revolution", date: new Date("2022-11-30"), color: "#9370DB" },
  { name: "Social Media Age", date: new Date("2004-02-04"), color: "#DA70D6" },
  { name: "Smartphone Era", date: new Date("2007-06-29"), color: "#FF69B4" },
  { name: "World Wide Web", date: new Date("1991-08-06"), color: "#00CED1" },
  { name: "Internet Public", date: new Date("1983-01-01"), color: "#20B2AA" },
  { name: "Personal Computer", date: new Date("1975-01-01"), color: "#5F9EA0" },
  { name: "Microprocessor", date: new Date("1971-11-15"), color: "#4682B4" },
  { name: "Moon Landing", date: new Date("1969-07-20"), color: "#C0C0C0" },
  { name: "Space Age", date: new Date("1957-10-04"), color: "#191970" },
  { name: "DNA Structure", date: new Date("1953-04-25"), color: "#9ACD32" },
  { name: "Transistor", date: new Date("1947-12-16"), color: "#FFD700" },
  { name: "Nuclear Age", date: new Date("1945-07-16"), color: "#FF6347" },
  { name: "Television", date: new Date("1927-01-01"), color: "#4169E1" },
  { name: "Penicillin", date: new Date("1928-01-01"), color: "#98FB98" },
  { name: "Assembly Line", date: new Date("1913-01-01"), color: "#696969" },
  { name: "Airplane", date: new Date("1903-12-17"), color: "#87CEFA" },
  { name: "Radio", date: new Date("1895-01-01"), color: "#FF8C00" },
  { name: "Light Bulb", date: new Date("1879-01-01"), color: "#FFFF00" },
  { name: "Telegraph", date: new Date("1837-01-01"), color: "#BDB76B" },
  { name: "Photography", date: new Date("1826-01-01"), color: "#A9A9A9" },
  { name: "Steam Engine", date: new Date("1776-01-01"), color: "#778899" },
  { name: "Industrial Revolution", date: new Date("1760-01-01"), color: "#696969" },
  { name: "Scientific Revolution", yearsAgo: 450, color: "#9370DB" },
  { name: "Renaissance", yearsAgo: 600, color: "#DEB887" },
  { name: "Columbus Americas", date: new Date("1492-10-12"), color: "#6495ED" },
  { name: "Printing Press", date: new Date("1440-01-01"), color: "#4B0082" },
  { name: "Roman Empire", yearsAgo: 2000, color: "#CD5C5C" },
  { name: "Ancient Greece", yearsAgo: 2500, color: "#B0C4DE" },
  { name: "Iron Age", yearsAgo: 3200, color: "#708090" },
  { name: "Pyramids", yearsAgo: 4500, color: "#DAA520" },
  { name: "Writing", yearsAgo: 5200, color: "#87CEEB" },
  { name: "Bronze Age", yearsAgo: 5300, color: "#CD7F32" },
  { name: "First Cities", yearsAgo: 9000, color: "#B8860B" },
  { name: "Agriculture", yearsAgo: 12000, color: "#90EE90" },
  { name: "Cave Art", yearsAgo: 40000, color: "#DEB887" },
  { name: "Homo Sapiens", yearsAgo: 300000, color: "#FFE4B5" },
  { name: "Fire Control", yearsAgo: 1e6, color: "#FF4500" },
  { name: "Stone Tools", yearsAgo: 3.3e6, color: "#A9A9A9" },
  { name: "First Hominids", yearsAgo: 6e6, color: "#F4A460" },
  { name: "First Apes", yearsAgo: 20e6, color: "#CD853F" },
  { name: "First Primates", yearsAgo: 55e6, color: "#DDA0DD" },
  { name: "Dinosaurs Extinct", yearsAgo: 66e6, color: "#DC143C" },
  { name: "First Birds", yearsAgo: 150e6, color: "#87CEEB" },
  { name: "First Mammals", yearsAgo: 225e6, color: "#D2691E" },
  { name: "Dinosaurs Appear", yearsAgo: 230e6, color: "#8B4513" },
  { name: "First Reptiles", yearsAgo: 320e6, color: "#556B2F" },
  { name: "First Amphibians", yearsAgo: 370e6, color: "#8FBC8F" },
  { name: "Plants on Land", yearsAgo: 470e6, color: "#228B22" },
  { name: "First Fish", yearsAgo: 530e6, color: "#1E90FF" },
  { name: "Cambrian Explosion", yearsAgo: 541e6, color: "#FF1493" },
  { name: "Multicellular Life", yearsAgo: 600e6, color: "#FF69B4" },
  { name: "Oxygen Atmosphere", yearsAgo: 2.4e9, color: "#00CED1" },
  { name: "Life Begins", yearsAgo: 3.8e9, color: "#32CD32" },
  { name: "Earth Forms", yearsAgo: 4.54e9, color: "#4169E1" },
  { name: "Solar System", yearsAgo: 4.6e9, color: "#FFA500" },
  { name: "Milky Way", yearsAgo: 13.5e9, color: "#9370DB" },
  { name: "First Stars", yearsAgo: 13.6e9, color: "#FFD700" }
];

// =============================
// Helper: seconds ago for an event
// =============================
function calculateSecondsAgo(event) {
  const now = getCurrentTime();
  if (event.yearsAgo !== undefined) {
    return event.yearsAgo * SECONDS_PER_YEAR;
  } else if (event.date) {
    return (now - event.date.getTime()) / 1000;
  }
  return 0;
}

// =============================
// Scale functions
// =============================
function linearScale(secondsAgo, maxSecondsAgo) {
  return secondsAgo / maxSecondsAgo;
}

function logScale(secondsAgo, maxSecondsAgo) {
  const logPos = Math.log10(secondsAgo + 1);
  const logMax = Math.log10(maxSecondsAgo + 1);
  return logPos / logMax;
}

function getScale(secondsAgo, maxSecondsAgo) {
  return isLinearMode ? linearScale(secondsAgo, maxSecondsAgo) : logScale(secondsAgo, maxSecondsAgo);
}

// =============================
// Canvas transforms
// =============================
function toCanvasX(worldX) { return (worldX + offsetX) * zoom; }
function toCanvasY(worldY) { return (worldY + offsetY) * zoom; }

// =============================
// Formatting
// =============================
function formatNumber(n) {
  return n.toLocaleString('en-US', { maximumFractionDigits: 0 });
}

// =============================
// Draw Loop (with error handling)
// =============================
function draw() {
  try {
    // Draw background
    if (bgImage.complete && bgImage.naturalWidth > 0) {
      ctx.drawImage(bgImage, 0, 0, WIDTH, HEIGHT);
    } else {
      ctx.fillStyle = "#000";
      ctx.fillRect(0, 0, WIDTH, HEIGHT);
    }
    
    // Update zoom display
    document.getElementById('zoomLevel').textContent = zoom.toFixed(2) + 'x';
    
    if (!universeStartTime) {
      ctx.fillStyle = "white";
      ctx.font = "14px monospace";
      ctx.fillText("Initializing...", WIDTH / 2 - 50, HEIGHT / 2);
      requestAnimationFrame(draw);
      return;
    }
    
    const now = getCurrentTime();
    
    // Big Bang counters
    const totalSeconds = Math.floor((now - universeStartTime) / 1000);
    const yearsSinceBigBang = Math.floor(totalSeconds / SECONDS_PER_YEAR);
    
    ctx.fillStyle = "#FFD700";
    ctx.font = "14px monospace";
    ctx.fillText("Big Bang: " + formatNumber(yearsSinceBigBang) + " years", 10, 25);
    ctx.fillStyle = "#FFF";
    ctx.font = "12px monospace";
    ctx.fillText(formatNumber(totalSeconds) + " seconds total", 10, 45);
    
    // Timeline line from top‑left (Big Bang) to bottom‑right (NOW)
    const padding = 100;
    const start = {x: padding, y: padding};
    const end = {x: WIDTH - padding, y: HEIGHT - padding};
    
    ctx.strokeStyle = "#888";
    ctx.lineWidth = 3;
    ctx.beginPath();
    ctx.moveTo(toCanvasX(start.x), toCanvasY(start.y));
    ctx.lineTo(toCanvasX(end.x), toCanvasY(end.y));
    ctx.stroke();
    
    // Big Bang point
    ctx.fillStyle = "#FFD700";
    ctx.beginPath();
    ctx.arc(toCanvasX(start.x), toCanvasY(start.y), DOT_RADIUS * 2.5, 0, Math.PI * 2);
    ctx.fill();
    ctx.fillStyle = "white";
    ctx.font = "13px monospace";
    ctx.fillText("Big Bang", toCanvasX(start.x) - 60, toCanvasY(start.y) - 15);
    ctx.font = "11px monospace";
    ctx.fillStyle = "#FFD700";
    ctx.fillText(formatNumber(yearsSinceBigBang) + " y", toCanvasX(start.x) - 50, toCanvasY(start.y) + 18);
    ctx.fillText(formatNumber(totalSeconds) + " s", toCanvasX(start.x) - 50, toCanvasY(start.y) + 30);
    
    // NOW point
    ctx.fillStyle = "#FF0000";
    ctx.beginPath();
    ctx.arc(toCanvasX(end.x), toCanvasY(end.y), DOT_RADIUS * 2.5, 0, Math.PI * 2);
    ctx.fill();
    ctx.fillStyle = "white";
    ctx.font = "13px monospace";
    ctx.fillText("NOW", toCanvasX(end.x) + 15, toCanvasY(end.y) - 15);
    ctx.font = "11px monospace";
    ctx.fillStyle = "#FF0000";
    ctx.fillText("0 y", toCanvasX(end.x) + 15, toCanvasY(end.y) + 5);
    ctx.fillText("0 s", toCanvasX(end.x) + 15, toCanvasY(end.y) + 18);
    
    // Historical events
    EVENTS.forEach(event => {
      const secondsAgo = calculateSecondsAgo(event);
      const yearsAgo = Math.floor(secondsAgo / SECONDS_PER_YEAR);
      const frac = getScale(secondsAgo, BIG_BANG_SECONDS_AGO);
      
      // Invert fraction so 0 = Big Bang, 1 = NOW
      const fracPos = 1 - frac;
      const x = start.x + (end.x - start.x) * fracPos;
      const y = start.y + (end.y - start.y) * fracPos;
      
      ctx.fillStyle = event.color || "#888";
      ctx.beginPath();
      ctx.arc(toCanvasX(x), toCanvasY(y), DOT_RADIUS * 1.5, 0, Math.PI * 2);
      ctx.fill();
      
      ctx.fillStyle = "#FFF";
      ctx.font = "11px monospace";
      ctx.fillText(event.name, toCanvasX(x) + 8, toCanvasY(y));
      
      ctx.font = "9px monospace";
      ctx.fillStyle = "#DDD";
      ctx.fillText(formatNumber(yearsAgo) + " y", toCanvasX(x) + 8, toCanvasY(y) + 13);
      ctx.fillText(formatNumber(Math.floor(secondsAgo)) + " s", toCanvasX(x) + 8, toCanvasY(y) + 23);
    });
    
    // User's birth
    if (birthDate) {
      const secondsAgo = (now - birthDate.getTime()) / 1000;
      const yearsAgo = Math.floor(secondsAgo / SECONDS_PER_YEAR);
      const frac = getScale(secondsAgo, BIG_BANG_SECONDS_AGO);
      
      const fracPos = 1 - frac;
      const x = start.x + (end.x - start.x) * fracPos;
      const y = start.y + (end.y - start.y) * fracPos;
      
      ctx.fillStyle = "#00FFFF";
      ctx.beginPath();
      ctx.arc(toCanvasX(x), toCanvasY(y), DOT_RADIUS * 2, 0, Math.PI * 2);
      ctx.fill();
      
      ctx.fillStyle = "#00FFFF";
      ctx.font = "11px monospace";
      ctx.fillText("YOU", toCanvasX(x) + 8, toCanvasY(y));
      
      ctx.font = "9px monospace";
      ctx.fillStyle = "#AAF0FF";
      ctx.fillText(formatNumber(yearsAgo) + " y", toCanvasX(x) + 8, toCanvasY(y) + 13);
      ctx.fillText(formatNumber(Math.floor(secondsAgo)) + " s", toCanvasX(x) + 8, toCanvasY(y) + 23);
    }
    
    // ----- Live timestamp (proof that time advances) -----
    ctx.fillStyle = "#888";
    ctx.font = "10px monospace";
    ctx.fillText(new Date(now).toISOString().substr(11,8), WIDTH - 100, HEIGHT - 10);
    // ----------------------------------------------------
    
  } catch (e) {
    console.error("Draw error:", e);
  }
  
  // Continue the animation loop
  requestAnimationFrame(draw);
}

// Start drawing
draw();
</script>

</body>
</html>